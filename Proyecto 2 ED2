//Librerias
#include <Arduino.h>
#include <ESP32Servo.h>
#include <Esp32WifiManager.h>

//Display de 7 segmentos
#define pinA  34
#define pinB  35
#define pinC  32
#define pinD  33
#define pinE  25
#define pinF  26
#define pinG  27
#define pindP  14

#define display1  4
#define display2  2
#define display3  15

//Pines de Leds
const int greenLed = 21;
const int yellowLed = 29;
const int redLed = 18;

//Pin analógica para sensor de temperatura LM35
const int LM35Pin = A0;  

//Boton de inicio
const int buttonPin = 22;

// Definición de pines para el servo
const int servoPin = 5;

// Variables para almacenar la temperatura
int sensorValue = 0;
float temperature = 0.0;

// Variables para las señales PWM
int greenBrightness = 0;
int yellowBrightness = 0;
int redBrightness = 0;
int servoAngle = 0; 

bool measureTemperature = false; //Indicador para medir la temperatura al presionar el boton "Start"



//Definicón de la posición del servo y cambio de color
int posición inicial = 90;
int movimiento = 15; 
int cammbioColor = 0; //0: apagado; 1:verde; 2:amarillo; 3:rojo;
int cambioServo = 0;


/*void setup()
{
  Serial.begin(9600);
  pinMode(sensroTemp,INPUT);
  pinMode(servo,OUTPUT);
}

void loop () {
  delay(100);

  if (digitalRead (buttonStart) == HIGH);
}

void loop() 
{
Value = analogRead(sensorTemp);
Temperature = ( Value * 5.0 * 100.0)/1023.0;
if(Temperature < 37)
{
  digitalWrite(greenLed,HIGH);
}
else if (Temperatura 37 < && < 37.5 )
{
  digitalWrite(yellowLed,HIGH);
}
else if (Temperature < 37.5)
{
    digitalWrite(redLed,HIGH);
}
  Serial.println(Temperature);
  delay(50)
}*/

//Parte 1: Sensor de temperatura
//Parte 2: Semáforo de temperatura 
//Parte 3: Reloj de semáforo de temperatura

void setup() {
  Serial.begin(115200);

  // Configurar leds como salidas
  pinMode(greenLed, OUTPUT);
  pinMode(yellowLed, OUTPUT);
  pinMode(greenLed, OUTPUT);

  // Configurar el botón como entrada con resistencia interna
  pinMode(buttonStart, INPUT_PULLUP);

  // Configurar pin del servo
  pinMode(servoPin, OUTPUT);
}


void loop() {
  // Leer el estado del botón
  int buttonState = digitalRead(buttonStart);

  // Si se presiona el botón se comienza a medir la temperatura
  if (buttonState == LOW) {
    measureTemperature = true;
  }

  if (measureTemperature) {
    // Leer el valor del sensor LM35
    sensorValue = analogRead(LM35Pin);

    // Convertir el valor del ADC a temperatura en grados Celsius mediante el uso de una formula
    temperature = (sensorValue * 3300.0) / 4095.0; 
    temperature = temperature / 10.0; 

    // Determinar led prendido y angulo del servo segun la temperatura
    if (temperature < 37.0) {
      greenBrightness = 255;
      yellowBrightness = 0;
      redBrightness = 0;
      servoAngle = 45; // Mover servo a 45°
    } else if (temperature >= 37.0 && temperature < 37.5) {
      greenBrightness = 0;
      yellowBrightness = 255;
      redBrightness = 0;
      servoAngle = 90; // Mover servo a 90°
    } else {
      greenBrightness = 0;
      yellowBrightness = 0;
      redBrightness = 255;
      servoAngle = 135; // Mover servo a 135°
    }

    // Aplicar las señales PWM a los Leds y al servo
    analogWrite(greenLed, greenBrightness);
    analogWrite(yellowLed, yellowBrightness);
    analogWrite(redLed, redBrightness);

    for (int angle = 0; angle <= servoAngle; angle++) {
      analogWrite(servoPin, map(angle, 0, 180, 0, 255));
      delay(15);
    }
    for (int angle = servoAngle; angle >= 0; angle--) {
      analogWrite(servoPin, map(angle, 0, 180, 0, 255));
      delay(15);
    }

    measureTemperature = false; // Reiniciar el sensor luego de medir la temepratura
  }

  delay(100); 
}





//Parte 4: Despliegue de temperatura 


/*void desplegar7seg(uint8_t digito) {
  switch (digito) {
    case 0:
      digitalWrite(pinA, HIGH);
      digitalWrite(pinB, HIGH);
      digitalWrite(pinC, HIGH);
      digitalWrite(pinD, HIGH);
      digitalWrite(pinE, HIGH);
      digitalWrite(pinF, HIGH);
      digitalWrite(pinG, LOW);
      break;
    case 1:
      digitalWrite(pinA, LOW);
      digitalWrite(pinB, HIGH);
      digitalWrite(pinC, HIGH);
      digitalWrite(pinD, LOW);
      digitalWrite(pinE, LOW);
      digitalWrite(pinF, LOW);
      digitalWrite(pinG, LOW);
      break;
    case 2:
      digitalWrite(pinA, HIGH);
      digitalWrite(pinB, HIGH);
      digitalWrite(pinC, LOW);
      digitalWrite(pinD, HIGH);
      digitalWrite(pinE, HIGH);
      digitalWrite(pinF, LOW);
      digitalWrite(pinG, HIGH);
      break;
    case 3:
      digitalWrite(pinA, HIGH);
      digitalWrite(pinB, HIGH);
      digitalWrite(pinC, HIGH);
      digitalWrite(pinD, HIGH);
      digitalWrite(pinE, LOW);
      digitalWrite(pinF, LOW);
      digitalWrite(pinG, HIGH);
      break;
    case 4:
      digitalWrite(pinA, LOW);
      digitalWrite(pinB, HIGH);
      digitalWrite(pinC, HIGH);
      digitalWrite(pinD, LOW);
      digitalWrite(pinE, LOW);
      digitalWrite(pinF, HIGH);
      digitalWrite(pinG, HIGH);
      break;
    case 5:
      digitalWrite(pinA, HIGH);
      digitalWrite(pinB, LOW);
      digitalWrite(pinC, HIGH);
      digitalWrite(pinD, HIGH);
      digitalWrite(pinE, LOW);
      digitalWrite(pinF, HIGH);
      digitalWrite(pinG, HIGH);
      break;
    case 6:
      digitalWrite(pinA, HIGH);
      digitalWrite(pinB, LOW);
      digitalWrite(pinC, HIGH);
      digitalWrite(pinD, HIGH);
      digitalWrite(pinE, HIGH);
      digitalWrite(pinF, HIGH);
      digitalWrite(pinG, HIGH);
      break;
    case 7:
      digitalWrite(pinA, HIGH);
      digitalWrite(pinB, HIGH);
      digitalWrite(pinC, HIGH);
      digitalWrite(pinD, LOW);
      digitalWrite(pinE, LOW);
      digitalWrite(pinF, LOW);
      digitalWrite(pinG, LOW);
      break;
    case 8:
      digitalWrite(pinA, HIGH);
      digitalWrite(pinB, HIGH);
      digitalWrite(pinC, HIGH);
      digitalWrite(pinD, HIGH);
      digitalWrite(pinE, HIGH);
      digitalWrite(pinF, HIGH);
      digitalWrite(pinG, HIGH);
      break;
    case 9:
      digitalWrite(pinA, HIGH);
      digitalWrite(pinB, HIGH);
      digitalWrite(pinC, HIGH);
      digitalWrite(pinD, HIGH);
      digitalWrite(pinE, LOW);
      digitalWrite(pinF, HIGH);
      digitalWrite(pinG, LOW);
      break;
    default:
      break;
  }
} */ 

//Parte 5
//Parte 6
